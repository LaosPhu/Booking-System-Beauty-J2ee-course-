<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/adminbooking.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Add Bootstrap JS (Optional: Popper.js is required for certain Bootstrap components like modals) -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

    <style>

    /* Custom styles for the admin dashboard layout */
    body {
        margin: 0;
        padding: 0;
        background-color: #f4f6f9; /* Light background */
    }
    .admin-container {
        display: flex;
        min-height: 100vh;
    }

    /* Sidebar Styles */
    .admin-sidebar {
        background-color: #30303d; /* Dark sidebar */
        color: white;
        width: 250px; /* Fixed width */
        padding-top: 20px;
        transition: width 0.3s ease; /* Smooth transition for collapsing */
        position: fixed; /* Fixed position */
        height: 100%;
        overflow-y: auto; /* Scrollable content */
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 10; /* Ensure sidebar is above other elements */
    }

    .admin-sidebar .logo {
        text-align: center;
        margin-bottom: 20px;
    }
    .admin-sidebar .logo a{
      color: white;
      font-size: 24px;
      font-weight: bold;
      text-decoration: none;
    }

    .admin-sidebar .nav-item {
        padding: 10px 20px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .admin-sidebar .nav-item:hover {
        background-color: #444451; /* Darker hover */
    }

    .admin-sidebar .nav-item.active {
        background-color: #4a148c; /* Active color */
    }

    .admin-sidebar .nav-link {
        color: white;
        text-decoration: none;
        display: flex; /* Use flexbox for icon alignment */
        align-items: center; /* Vertically center icon and text */
        gap: 10px; /* Space between icon and text */
    }

    .admin-sidebar .nav-link i {
        margin-right: 5px; /* Space between icon and text */
        width: 20px; /* Fixed width for icons */
        text-align: center;
    }

    /* Main Content Styles */
    .main-content {
        flex: 1; /* Take up remaining space */
        padding: 20px;
        padding-left: 270px; /* Leave space for the sidebar */
        transition: padding-left 0.3s ease; /* Smooth transition for content shift */
        min-height: 100vh;
        background-color: #f9f9f9;
    }

    .content-wrapper {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Responsive adjustments for smaller screens */
    @media (max-width: 768px) { /* Medium screens and below (tablets) */
        .admin-sidebar {
            width: 100%; /* Full width on small screens */
            position: fixed; /* Make it fixed */
            top: 0;
            left: 0;
            z-index: 1000; /* High z-index to be on top */
            transform: translateX(-100%); /* Start off-screen */
            transition: transform 0.3s ease; /* Smooth slide-in */
            height: 100vh;
            overflow-y: auto;
        }
        .admin-sidebar.show {
            transform: translateX(0); /* Slide in when show class is added */
        }
        .main-content {
            padding-left: 20px; /* Reduce padding-left on small screens */
        }
        .menu-toggle {
            display: block; /* Show menu toggle button */
        }
    }

    /* Menu Toggle Button */
    .menu-toggle {
        position: fixed; /* Fix button to the top left */
        top: 10px;
        left: 10px;
        background-color: #4a148c;
        color: white;
        border: none;
        padding: 10px;
        padding-left: 15px;
        padding-right: 15px;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1001; /* Sit on top of everything */
        display: none; /* Hide by default on larger screens */
        align-items: center;
        gap: 5px;
    }

    .menu-toggle i{
        font-size: 18px;
    }
    .hidden{
      display: none;
    }


    .table-wrapper {
    max-height: 500px; /* Giới hạn chiều cao của bảng (khoảng 6 dòng) */
    overflow-y: auto;  /* Thêm thanh cuộn dọc */
    -webkit-overflow-scrolling: touch; /* Cuộn mượt mà trên thiết bị di động */
}

    .table {
        width: 100%;  /* Đảm bảo bảng chiếm toàn bộ chiều rộng */
    }

    .table thead, table tbody tr {
        width: 100%;
        table-layout: fixed;
    }
    .sticky-header th {
        position: sticky;
        top: 0;
        background-color: #343a40; /* Đảm bảo tiêu đề có nền màu */
        z-index: 1;
    }


}

</style>
</head>
<body>
<div class="admin-container">
    <aside class="admin-sidebar" id="admin-sidebar">
        <div class="logo">
            <a href="#">Bliss Admin</a>
        </div>
        <nav class="nav-menu">
            <div class="nav-item">
                <a href="/admin" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="/admin-user" class="nav-link">
                    <i class="fas fa-users"></i> <span>Users</span>
                </a>
            </div>
            <div class="nav-item active">
                <a href="/admin-service" class="nav-link">
                    <i class="fas fa-spa"></i> <span>Services</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="/admin-booking" class="nav-link">
                    <i class="fas fa-calendar-alt"></i> <span>Bookings</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link">
                    <i class="fas fa-comments"></i> <span>Reviews</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link">
                    <i class="fas fa-chart-bar"></i> <span>Reports</span>
                </a>
            </div>
            <div class="nav-item">
                <a  onclick="logout()" href="#" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                </a>
            </div>
        </nav>
    </aside>

    <main class="main-content" id="main-content">
        <div class="content-wrapper">
            <h2>Service List</h2>
            <div class="card mb-4 p-3 shadow-sm border-0" style="background-color: #e0f2f1;">

                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <input type="text" id="search-id" class="form-control border-teal h-100" placeholder="Search by Service ID">
                        </div>

                        <div class="col-md-3">
                            <select id="sort-price" class="form-select h-100">
                                <option value="">Sort by Price</option>
                                <option value="asc">Price: Low to High</option>
                                <option value="desc">Price: High to Low</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <button id="search-btn" class="btn btn-teal w-100 h-100">
                                <i class="fas fa-search me-1"></i> Search
                            </button>
                        </div>

                        <div class="col-md-2">
                            <button id="reset-btn" class="btn btn-secondary w-100 h-100">
                                <i class="fas fa-sync-alt me-1"></i> Reset
                            </button>
                        </div>

                        <div class="col-md-2">
                            <button class="btn btn-primary w-100 h-100" id="add-service-btn" data-bs-toggle="modal" data-bs-target="#add-service-modal">
                                <i class="fas fa-plus me-1"></i> Add Service
                            </button>
                        </div>

                </div>

            </div>
            <!-- Wrapper for horizontal scrolling -->
            <div class="table-wrapper">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark sticky-header">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Duration</th>
                        <th>Image</th>
                        <th>Price</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="service : ${services}">
                        <td th:text="${service.serviceId}"></td>
                        <td th:text="${service.name}"></td>
                        <td th:text="${service.category}"></td>
                        <td th:text="${service.description}"></td>
                        <td th:text="${service.duration}"></td>
                        <td><img th:src="${service.imageURL}" alt="Service Image" style="width: 100px; height: auto;"></td>
                        <td th:text="${service.price}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal for adding service -->
        <div class="modal" tabindex="-1" id="add-service-modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Service</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="add-service-form">
                            <div class="mb-3">
                                <label for="service-name" class="form-label">Service Name</label>
                                <input type="text" class="form-control" id="service-name" placeholder="Enter service name" required>
                            </div>
                            <div class="mb-3">
                                <label for="service-category" class="form-label">Category</label>
                                <input type="text" class="form-control" id="service-category" placeholder="Enter category" required>
                            </div>
                            <div class="mb-3">
                                <label for="service-description" class="form-label">Description</label>
                                <textarea class="form-control" id="service-description" rows="3" placeholder="Enter description" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="service-duration" class="form-label">Duration (in minutes)</label>
                                <input type="number" class="form-control" id="service-duration" placeholder="Enter duration" required>
                            </div>
                            <!-- Thay input nhập URL ảnh bằng bộ chọn ảnh -->
                            <div class="mb-3">
                                <label class="form-label">Choose Image</label>
                                <div id="image-selection" style="display:flex; flex-wrap: wrap; gap: 10px; max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px;">
                                    <!-- Ảnh sẽ được load ở đây -->
                                    <p>Loading images...</p>
                                </div>
                                <!-- Input ẩn để lưu ảnh được chọn -->
                                <input type="hidden" id="service-image" name="service-image" required>
                            </div>
                            <div class="mb-3">
                                <label for="service-price" class="form-label">Price</label>
                                <input type="number" class="form-control" id="service-price" placeholder="Enter price" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="submit-service-btn">Add Service</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal for editing service -->
        <div class="modal fade" id="edit-service-modal" tabindex="-1" aria-labelledby="editServiceModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Service</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="edit-id">
                        <div class="mb-3">
                            <label for="edit-name" class="form-label">Service Name</label>
                            <input type="text" id="edit-name" class="form-control" placeholder="Enter service name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-category" class="form-label">Category</label>
                            <input type="text" id="edit-category" class="form-control" placeholder="Enter category" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-description" class="form-label">Description</label>
                            <textarea id="edit-description" class="form-control" rows="3" placeholder="Enter description" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-duration" class="form-label">Duration (in minutes)</label>
                            <input type="number" id="edit-duration" class="form-control" placeholder="Enter duration" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Choose Image</label>
                            <div id="edit-image-selection"
                                 style="display:flex; flex-wrap: wrap; gap: 10px; max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px;">
                                <!-- Ảnh sẽ được load ở đây -->
                                <p>Loading images...</p>
                            </div>
                            <input type="hidden" id="edit-image" name="edit-image" required />
                        </div>

                        <div class="mb-3">
                            <label for="edit-price" class="form-label">Price</label>
                            <input type="number" id="edit-price" class="form-control" placeholder="Enter price" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="save-edit-btn" class="btn btn-success">Save</button>
                    </div>
                </div>
            </div>
        </div>


    </main>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetchServices();

        // Load tất cả dịch vụ
        function fetchServices() {
            fetch('/api/service/getAll')
                .then(response => response.json())
                .then(data => {
                    const filtered = data.filter(service => service.status === true);
                    renderTable(filtered);
                })
                .catch(error => console.error('Error fetching services:', error));
        }

        // Render bảng dịch vụ
        function renderTable(serviceList) {
            const tableBody = document.querySelector("table tbody");
            tableBody.innerHTML = '';

            serviceList.forEach(service => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${service.serviceId}</td>
                    <td>${service.name}</td>
                    <td>${service.category}</td>
                    <td>${service.description}</td>
                    <td>${service.duration}</td>
                    <td><img src="${service.imageURL}" alt="Service Image" style="width: 100px; height: auto;"></td>
                    <td>${service.price}</td>
                    <td>
                        <button class="edit-btn btn btn-warning btn-sm"
                            data-id="${service.serviceId}"
                            data-name="${service.name}"
                            data-category="${service.category}"
                            data-description="${service.description}"
                            data-duration="${service.duration}"
                            data-image="${service.imageURL}"
                            data-price="${service.price}">
                        Edit</button>
                        <button class="delete-btn btn btn-danger btn-sm" data-id="${service.serviceId}">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            attachEditEvents();
            attachDeleteEvents();
        }

        // Tìm kiếm theo serviceId
        document.getElementById("search-btn").addEventListener("click", function () {
            const searchId = document.getElementById("search-id").value.trim();

            fetch('/api/service/getAll')
                .then(response => response.json())
                .then(data => {
                    const filtered = data.filter(service =>
                        service.status === true &&
                        service.serviceId.toString().includes(searchId)
                    );
                    renderTable(filtered);
                })
                .catch(error => console.error('Error searching services:', error));
        });

        // Sắp xếp theo giá
        document.getElementById("sort-price").addEventListener("change", function () {
            const sortValue = this.value;
            fetch('/api/service/getAll')
                .then(response => response.json())
                .then(data => {
                    const filtered = data.filter(service => service.status === true);

                    if (sortValue === "asc") {
                        filtered.sort((a, b) => a.price - b.price);
                    } else if (sortValue === "desc") {
                        filtered.sort((a, b) => b.price - a.price);
                    }

                    renderTable(filtered);
                })
                .catch(error => console.error('Error sorting services:', error));
        });

        // Reset tìm kiếm và sắp xếp
        document.getElementById("reset-btn").addEventListener("click", function () {
            document.getElementById("search-id").value = "";
            document.getElementById("sort-price").value = "";
            fetchServices();
        });

        // Xoá dịch vụ
        function deleteService(serviceId) {
            const confirmDelete = confirm("Are you sure you want to delete this service?");
            if (!confirmDelete) return;

            fetch(`/api/service/delete/${serviceId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        alert('Service deleted successfully');
                        fetchServices();
                    } else {
                        alert('Service not found');
                    }
                })
                .catch(error => console.error('Error deleting service:', error));
        }

        // Gán sự kiện nút Edit
        function attachEditEvents() {
    const editButtons = document.querySelectorAll(".edit-btn");
    editButtons.forEach(button => {
        button.addEventListener("click", () => {
            const service = {
                id: button.getAttribute("data-id"),
                name: button.getAttribute("data-name"),
                category: button.getAttribute("data-category"),
                description: button.getAttribute("data-description"),
                duration: button.getAttribute("data-duration"),
                imageURL: button.getAttribute("data-image"),
                price: button.getAttribute("data-price")
            };
            openEditModal(service);  // <-- gọi hàm bạn đã viết ở đây
        });
    });
}

        // Gán sự kiện nút Delete
        function attachDeleteEvents() {
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const serviceId = this.getAttribute('data-id');
                    deleteService(serviceId);
                });
            });
        }

        // Gửi PUT để cập nhật dịch vụ
        document.getElementById("save-edit-btn").addEventListener("click", function () {
            const id = document.getElementById("edit-id").value;
            const updatedService = {
                name: document.getElementById("edit-name").value,
                category: document.getElementById("edit-category").value,
                description: document.getElementById("edit-description").value,
                duration: document.getElementById("edit-duration").value,
                imageURL: document.getElementById("edit-image").value,
                price: document.getElementById("edit-price").value
            };

            fetch(`/api/service/edit/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedService)
            })
                .then(response => {
                    if (response.ok) {
                        alert('Cập nhật thành công!');
                        fetchServices();
                        $('#edit-service-modal').modal('hide');
                    } else {
                        alert('Có lỗi xảy ra khi cập nhật.');
                    }
                })
                .catch(error => {
                    console.error('Error updating service:', error);
                });
        });

        function loadEditImages(selectedImageUrl) {
    fetch('/api/service/images')
        .then(res => res.json())
        .then(images => {
            const container = document.getElementById('edit-image-selection');
            container.innerHTML = '';

            if (images.length === 0) {
                container.innerHTML = '<p>No images found</p>';
                return;
            }

            images.forEach(imgName => {
                const imgPath = `/images/${imgName}`;
                const img = document.createElement('img');
                img.src = imgPath;
                img.style.width = '80px';
                img.style.height = '80px';
                img.style.objectFit = 'cover';
                img.style.cursor = 'pointer';
                img.style.border = '2px solid transparent';
                img.title = imgName;

                if (imgPath === selectedImageUrl) {
                    img.style.border = '2px solid blue';
                }

                img.addEventListener('click', () => {
                    document.querySelectorAll('#edit-image-selection img').forEach(i => i.style.border = '2px solid transparent');
                    img.style.border = '2px solid blue';
                    document.getElementById('edit-image').value = imgPath;
                });

                container.appendChild(img);
            });
        })
        .catch(err => {
            const container = document.getElementById('edit-image-selection');
            container.innerHTML = '<p>Error loading images</p>';
            console.error('Error fetching images:', err);
        });
}
        function openEditModal(service) {
            document.getElementById('edit-id').value = service.id;
            document.getElementById('edit-name').value = service.name;
            document.getElementById('edit-category').value = service.category;
            document.getElementById('edit-description').value = service.description;
            document.getElementById('edit-duration').value = service.duration;
            document.getElementById('edit-price').value = service.price;
            document.getElementById('edit-image').value = service.imageURL;
            // Load ảnh và highlight ảnh hiện tại
            loadEditImages(service.imageURL);
            // Hiển thị modal
            $('#edit-service-modal').modal('show');
        }


        function loadImageSelection() {
        fetch('/api/service/images')
            .then(res => res.json())
            .then(images => {
                const container = document.getElementById('image-selection');
                container.innerHTML = '';

                if (images.length === 0) {
                    container.innerHTML = '<p>No images found</p>';
                    return;
                }

                images.forEach(imgName => {
                    const img = document.createElement('img');
                    img.src = `/images/${imgName}`;
                    img.style.width = '80px';
                    img.style.height = '80px';
                    img.style.objectFit = 'cover';
                    img.style.cursor = 'pointer';
                    img.style.border = '2px solid transparent';
                    img.title = imgName;

                    img.addEventListener('click', () => {
                        document.querySelectorAll('#image-selection img').forEach(i => i.style.border = '2px solid transparent');
                        img.style.border = '2px solid blue';
                        document.getElementById('service-image').value = `/images/${imgName}`;
                    });

                    container.appendChild(img);
                });
            })
            .catch(err => {
                const container = document.getElementById('image-selection');
                container.innerHTML = '<p>Error loading images</p>';
                console.error('Error fetching images:', err);
            });
    }

    // Gọi load ảnh khi mở modal thêm dịch vụ
    const addServiceModal = document.getElementById('add-service-modal');
    addServiceModal.addEventListener('show.bs.modal', loadImageSelection);

    // Thêm dịch vụ mới
    document.getElementById('submit-service-btn').addEventListener('click', function () {
        const serviceData = {
            name: document.getElementById('service-name').value,
            description: document.getElementById('service-description').value,
            duration: parseInt(document.getElementById('service-duration').value),
            price: parseFloat(document.getElementById('service-price').value),
            category: document.getElementById('service-category').value,
            imageURL: document.getElementById('service-image').value
        };

        if (!serviceData.imageURL) {
            alert('Please select an image');
            return;
        }

        fetch('/api/service/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(serviceData)
        })
            .then(response => response.json())
            .then(data => {
                if (data) {
                    alert('Service added successfully!');
                    $('#add-service-modal').modal('hide');
                    fetchServices();
                } else {
                    alert('Failed to add service');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('There was an error adding the service.');
            });
    });
    });
    function logout() {
      sessionStorage.removeItem('isLoggedIn');
      sessionStorage.removeItem('userRole');
      sessionStorage.removeItem('username');
      window.location.href='index.html';
  }
</script>

<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>

</body>
</html>
